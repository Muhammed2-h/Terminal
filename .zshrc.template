# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Cloud Terminal â€” Zsh Configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€ Guard: recover silently from invalid CWD (e.g. after /root symlink swap) â”€â”€
[[ -d "$PWD" ]] || cd ~

# â”€â”€ Path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Append extras â€” never fully replace PATH; OMZ/zsh build on it.
# Static paths ONLY â€” no subshells ($(...)) here; they would hang startup.
export PATH="$PATH:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
export PATH="$PATH:$HOME/.local/bin"    # pip --user installs
export PATH="$PATH:$HOME/.cargo/bin"    # Rust/cargo installs

# â”€â”€ Oh My Zsh performance guards (MUST come before source $ZSH/oh-my-zsh.sh) â”€
#
# WHY these matter on Railway / network volumes:
#
#  DISABLE_AUTO_UPDATE  â†’ OMZ's updater runs `git fetch` on ~/.oh-my-zsh every
#                         few days. Since ~/.oh-my-zsh lives on /data (a network
#                         volume), this blocks the entire shell startup for 10-60s.
#
#  'git' plugin removed â†’ The git plugin + robbyrussell theme call `git status`
#                         on EVERY prompt render (after every command). On /data
#                         this makes the shell appear frozen after each keypress.
#
DISABLE_AUTO_UPDATE="true"
DISABLE_UPDATE_PROMPT="true"
DISABLE_MAGIC_FUNCTIONS="true"       # faster paste; avoids URL-quoting hangs
DISABLE_UNTRACKED_FILES_DIRTY="true" # skip untracked-file scan in git status
ZSH_DISABLE_COMPFIX="true"           # skip slow compaudit security check

export ZSH="$HOME/.oh-my-zsh"

# No theme â€” we set a custom fast prompt below that NEVER calls git
ZSH_THEME=""

# Plugins: git plugin REMOVED (it scans repos on every prompt = hangs)
# zsh-autosuggestions + zsh-syntax-highlighting are safe; they read local memory
plugins=(zsh-autosuggestions zsh-syntax-highlighting)

source $ZSH/oh-my-zsh.sh

# â”€â”€ Custom prompt (instant â€” zero filesystem or git calls) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Format:  â¯ ~/your/path $
# Colors:  green arrow, bold cyan path
autoload -Uz promptinit && promptinit
PROMPT='%F{82}â¯%f %B%F{81}%~%f%b '
RPROMPT=''

# â”€â”€ Background Process Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Prevent zsh from sending SIGHUP to background jobs when the shell exits.
# Anything run with `&` will survive tab close automatically.
setopt NOHUP
setopt NO_CHECK_JOBS

# â”€â”€ persist: Run any command fully detached from this terminal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Usage:   persist <command> [args...]
# Example: persist npm run dev
# Example: persist python app.py
# Logs:    tail -f /tmp/persist-<name>.log
persist() {
    if [ $# -eq 0 ]; then
        echo "Usage: persist <command> [args...]"
        echo "Example: persist npm run dev"
        return 1
    fi
    local name
    name=$(basename "$1" 2>/dev/null || echo "$1")
    local logfile="/tmp/persist-${name}-$$.log"

    # setsid creates a brand-new Linux session fully detached from the PTY.
    # The process becomes a child of PID 1 and cannot receive SIGHUP ever.
    setsid "$@" > "$logfile" 2>&1 &
    local pid=$!
    disown "$pid"
    echo ""
    echo "  âœ… \033[1;32m'$*'\033[0m is running in the background"
    echo "  ğŸ“ PID: \033[1;33m$pid\033[0m"
    echo "  ğŸ“„ Logs: \033[1;34m$logfile\033[0m  (use: tail -f $logfile)"
    echo "  ğŸ”´ Stop: \033[1;31mkill $pid\033[0m"
    echo ""
}

# â”€â”€ plist: Show background persisted processes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plist() {
    echo ""
    echo "  â”€â”€ Background Processes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    ps -eo pid,stat,etime,cmd --no-headers \
        | grep -v "  Z " \
        | grep -v grep \
        | grep -v "ps -eo" \
        | awk '{printf "  PID %-7s | uptime %-10s | %s\n", $1, $3, substr($0, index($0,$4))}' \
        2>/dev/null || echo "  (none)"
    echo ""
}

# â”€â”€ Handy aliases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
alias l='ls -lah --color=auto'
alias ll='ls -lah --color=auto'
alias logs='tail -f /tmp/persist-*.log 2>/dev/null || echo "No persist logs found."'
alias preview='echo "Preview URL: ${RAILWAY_PUBLIC_DOMAIN:-localhost}:${PORT:-8080}/preview/"'

# â”€â”€ MOTD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_cloud_motd() {
    echo ""
    if [ -n "$TMUX" ]; then
        echo "  \033[1;32mâ—\033[0m \033[1mTmux session active\033[0m â€” this terminal is fully persistent."
        echo "    Closing the browser tab will NOT kill your processes."
    else
        echo "  \033[1;33mâ—\033[0m \033[1mCloud Terminal\033[0m â€” process persistence guide:"
        echo ""
        echo "    \033[0;37mâ€¢ Foreground apps die when tab closes (e.g. \`npm run dev\`)\033[0m"
        echo "    \033[1;32mâ€¢ Use \`persist\` to survive tab close:\033[0m"
        echo "        \033[0;32mpersist npm run dev\033[0m"
        echo "        \033[0;32mpersist python app.py\033[0m"
        echo "    \033[1;34mâ€¢ Or use tmux for full session persistence:\033[0m"
        echo "        \033[0;34mtmux\033[0m  â†’  start app  â†’  close tab safely"
        echo ""
    fi
}
_cloud_motd

# â”€â”€ User Custom Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Everything between BEGIN/END USER CONFIG is preserved across redeploys.
# Add your own aliases, exports, or functions below this line.
# BEGIN USER CONFIG
# END USER CONFIG
