# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Oh My Zsh Configuration â€” Cloud Terminal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Guard: if the shell spawns inside an invalid/deleted directory (e.g. during
# the /root â†’ /data/root symlink migration), silently recover to home.
# This eliminates the "no such file or directory" prompt on new terminal tabs.
[[ -d "$PWD" ]] || cd ~

# â”€â”€ Path (set BEFORE loading OMZ so it can build on top of these) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Append extra bins. Never fully replace PATH â€” OMZ and zsh need what's already there.
export PATH="$PATH:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
export PATH="$PATH:$HOME/.local/bin"          # pip --user installs
export PATH="$PATH:$HOME/.cargo/bin"          # Rust/cargo installs

# â”€â”€ Disable Oh My Zsh auto-update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OMZ checks for updates by running `git fetch` on ~/.oh-my-zsh at shell startup.
# Since ~/.oh-my-zsh lives on /data (Railway network volume), this HANGS the shell.
# Always disable it â€” update OMZ manually with `omz update` if needed.
DISABLE_AUTO_UPDATE="true"
DISABLE_UPDATE_PROMPT="true"

export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"
plugins=(git zsh-autosuggestions zsh-syntax-highlighting)
source $ZSH/oh-my-zsh.sh

# â”€â”€ Background Process Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Prevent zsh from sending SIGHUP to background jobs when the shell exits.
# This means anything you run with `&` or `nohup` will survive tab close.
setopt NOHUP
setopt NO_CHECK_JOBS

# â”€â”€ persist: Run any command detached from this terminal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Usage: persist <command> [args...]
# Example: persist npm run dev
# Example: persist python app.py
# Logs are written to /tmp/persist-<name>.log
persist() {
    if [ $# -eq 0 ]; then
        echo "Usage: persist <command> [args...]"
        echo "Example: persist npm run dev"
        return 1
    fi
    local name
    name=$(basename "$1" 2>/dev/null || echo "$1")
    local logfile="/tmp/persist-${name}-$$.log"

    # setsid creates a brand-new session â€” fully detached from the PTY.
    # The process will NOT receive SIGHUP when the browser tab closes.
    setsid "$@" > "$logfile" 2>&1 &
    local pid=$!
    disown "$pid"
    echo ""
    echo "  âœ… \033[1;32m'$*'\033[0m is running in the background"
    echo "  ğŸ“ PID: \033[1;33m$pid\033[0m"
    echo "  ğŸ“„ Logs: \033[1;34m$logfile\033[0m  (use: tail -f $logfile)"
    echo "  ğŸ”´ Stop: \033[1;31mkill $pid\033[0m"
    echo ""
}

# â”€â”€ plist: Show background persisted processes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plist() {
    echo ""
    echo "  â”€â”€ Background Processes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    ps -eo pid,stat,etime,cmd --no-headers \
        | grep -v "  Z " \
        | grep -v grep \
        | grep -v "ps -eo" \
        | awk '{printf "  PID %-7s | uptime %-10s | %s\n", $1, $3, substr($0, index($0,$4))}' \
        2>/dev/null || echo "  (none)"
    echo ""
}

# â”€â”€ Handy aliases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
alias l='ls -lah --color=auto'
alias ll='ls -lah --color=auto'
alias logs='tail -f /tmp/persist-*.log 2>/dev/null || echo "No persist logs found."'
alias preview='echo "Preview URL: ${RAILWAY_PUBLIC_DOMAIN:-localhost}:${PORT:-8080}/preview/"'

# â”€â”€ MOTD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_cloud_motd() {
    echo ""
    if [ -n "$TMUX" ]; then
        echo "  \033[1;32mâ—\033[0m \033[1mTmux session active\033[0m â€” this terminal is fully persistent."
        echo "    Closing the browser tab will NOT kill your processes."
    else
        echo "  \033[1;33mâ—\033[0m \033[1mCloud Terminal\033[0m â€” process persistence guide:"
        echo ""
        echo "    \033[0;37mâ€¢ Foreground apps die when tab closes (e.g. \`npm run dev\`)\033[0m"
        echo "    \033[1;32mâ€¢ Use \`persist\` to survive tab close:\033[0m"
        echo "        \033[0;32mpersist npm run dev\033[0m"
        echo "        \033[0;32mpersist python app.py\033[0m"
        echo "    \033[1;34mâ€¢ Or use tmux for full session persistence:\033[0m"
        echo "        \033[0;34mtmux\033[0m  â†’  start app  â†’  close tab safely"
        echo ""
    fi
}
_cloud_motd

# â”€â”€ User Custom Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Everything between BEGIN/END USER CONFIG is preserved across redeploys.
# Add your own aliases, exports, functions here.
# BEGIN USER CONFIG
# END USER CONFIG
